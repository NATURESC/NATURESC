<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>è‡ªç„¶æ³•åˆ™2025å¹´åº¦å¤§æŠ½å¥–</title>   
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            background: linear-gradient(180deg, #ffcf4b 0%, #ff9a00 100%);
            font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            overflow-x: hidden;
            padding-bottom: 60px;
        }

        .header { text-align: center; margin-top: 30px; color: #d93600; }
        .header h1 { font-size: 24px; font-weight: bold; border: 2px solid #333; display: inline-block; padding: 5px 20px; margin-bottom: 10px; background: #fffdf0; border-radius: 6px;}
        .header h2 { font-size: 32px; font-weight: 800; text-shadow: 1px 1px 2px rgba(255,255,255,0.5); color:#6b2100; margin-top:8px;}

        .wheel-container {
            position: relative;
            width: 320px; height: 320px;
            margin: 20px auto;
            padding: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            border-radius: 50%;
            background: linear-gradient(180deg, rgba(255,255,255,0.05), rgba(0,0,0,0.05));
            border: 4px solid #ffeb3b;
        }
        .wheel-container::after {
            content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            border-radius: 50%; border: 2px dashed rgba(255,255,255,0.25);
            animation: flash 1s infinite; pointer-events: none;
        }
        @keyframes flash { 0%, 100% { opacity: 0.5; } 50% { opacity: 1; } }

        .wheel {
            width: 100%; height: 100%;
            background: #fffdf0; border-radius: 50%;
            position: relative; overflow: hidden;
            transition: transform 4s cubic-bezier(0.2, 0.8, 0.3, 1);
        }
        .wheel-bg {
            width: 100%; height: 100%; border-radius: 50%;
            background: conic-gradient(
                #fffdf0 0deg 60deg, #ffe0b2 60deg 120deg,
                #fffdf0 120deg 180deg, #ffe0b2 180deg 240deg,
                #fffdf0 240deg 300deg, #ffe0b2 300deg 360deg
            );
        }
        .prize-item {
            position: absolute; top: 0; left: 50%;
            width: 100px; height: 50%; margin-left: -50px;
            transform-origin: bottom center; text-align: center;
            padding-top: 20px; font-size: 12px; color: #d35400; font-weight: bold;
        }
        .item-1 { transform: rotate(30deg); }
        .item-2 { transform: rotate(90deg); }
        .item-3 { transform: rotate(150deg); }
        .item-4 { transform: rotate(210deg); }
        .item-5 { transform: rotate(270deg); }
        .item-6 { transform: rotate(330deg); }
        .prize-icon { display: block; width: 30px; height: 30px; background: #ddd; margin: 5px auto; border-radius: 4px; line-height: 30px; font-size: 14px; color: #666; }

        .pointer {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 80px; height: 80px;
            background: linear-gradient(to bottom, #ffcc00, #ff9900);
            border-radius: 50%; border: 4px solid #fff;
            box-shadow: 0 4px 0 #cc7a00;
            z-index: 10; display: flex; justify-content: center; align-items: center;
            font-size: 20px; font-weight: bold; color: #d35400; cursor: pointer;
        }
        .pointer::before {
            content: ''; position: absolute; top: -20px; left: 50%;
            transform: translateX(-50%);
            border-width: 15px; border-style: solid;
            border-color: transparent transparent #ffcc00 transparent;
        }
        .pointer:active { transform: translate(-50%, -48%); box-shadow: 0 2px 0 #cc7a00; }
        .pointer.disabled {
            background: #ccc; box-shadow: 0 4px 0 #999; color: #666; cursor: not-allowed;
        }
        .pointer.disabled::before { border-bottom-color: #ccc; }

        .footer-list {
            width: 90%; background: rgba(255, 255, 255, 0.12);
            border-radius: 10px; padding: 10px; margin-top: 10px;
            text-align: center; z-index: 5; height: 150px;
            display: flex; flex-direction: column;
            backdrop-filter: blur(3px);
        }
        .list-title { color: #fff; font-size: 14px; margin-bottom: 8px; font-weight: bold; flex-shrink: 0;}
        .marquee-container { flex: 1; overflow-y: auto; position: relative; -webkit-overflow-scrolling: touch; padding:6px;}
        .marquee-container::-webkit-scrollbar { width: 6px; }
        .marquee-container::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 3px; }

        .record-item { color: #fff; font-size: 13px; line-height: 26px; border-bottom: 1px dashed rgba(255,255,255,0.12); padding: 2px 4px; text-align:left;}
        .record-item b { color: #d93600; background: rgba(255,255,255,0.6); padding: 0 6px; border-radius: 4px; margin-right:6px; font-weight:700;}
        .record-time { font-size: 11px; color: #fff; opacity: 0.85; float:right; }

        .city-bg { position: fixed; bottom: 0; width: 100%; height: 60px; background-color: #e67e22; mask-image: linear-gradient(to top, black, transparent); -webkit-mask-image: linear-gradient(to top, black, transparent); opacity: 0.5; z-index: 0; }

        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 100; display: none;
            justify-content: center; align-items: center;
        }
        .modal-box { background: #fff; width: 88%; max-width: 320px; padding: 20px; border-radius: 15px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.3); animation: popIn 0.25s; }
        .modal-title { font-size: 18px; color: #333; margin-bottom: 12px; font-weight: bold; }
        .modal-input { width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; margin-bottom: 12px; outline: none; }
        .modal-input:focus { border-color: #ff9900; }
        .modal-btn { background: linear-gradient(to right, #ff9900, #ff5e00); color: white; border: none; padding: 10px 30px; border-radius: 20px; font-size: 16px; cursor: pointer; box-shadow: 0 4px 10px rgba(255, 94, 0, 0.3); }

        @keyframes popIn { from { transform: scale(0.5); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    </style>

    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

    <!-- å§“åè¾“å…¥å¼¹çª— -->
    <div class="modal-overlay" id="nameModal">
        <div class="modal-box">
            <div class="modal-title">è¯·è¾“å…¥æ‚¨çš„å§“å</div>
            <input type="text" class="modal-input" id="usernameInput" placeholder="ä¾‹å¦‚ï¼šæå››" maxlength="20" />
            <div style="display:flex; justify-content:center; gap:10px;">
                <button class="modal-btn" onclick="submitName()">å¼€å§‹æŠ½å¥–</button>
            </div>
        </div>
    </div>

    <div class="header">
        <h1>æ¢æ¢</h1>
        <h2>æ¢æ¢5å‘¨å¹´<br>æ‹‰äººå¤§æŠ½å¥–</h2>
    </div>

    <div class="wheel-container">
        <div class="wheel" id="wheel">
            <div class="wheel-bg"></div>
            <div class="prize-item item-1"><span>çºªæ¢µå¸Œ<br>å°ç¾Šçš®å£çº¢</span><span class="prize-icon">ğŸ’„</span></div>
            <div class="prize-item item-2"><span>ARMANI<br>é˜¿ç›å°¼</span><span class="prize-icon">ğŸ</span></div>
            <div class="prize-item item-3"><span>æ¢æ¢<br>VIPä¼šå‘˜</span><span class="prize-icon">ğŸ‘‘</span></div>
            <div class="prize-item item-4"><span>iPhone<br>XS</span><span class="prize-icon">ğŸ“±</span></div>
            <div class="prize-item item-5"><span>åœ£ç½—å…°<br>å£çº¢</span><span class="prize-icon">ğŸ’„</span></div>
            <div class="prize-item item-6"><span>è°¢è°¢<br>å‚ä¸</span><span class="prize-icon">ğŸ˜Š</span></div>
        </div>

        <div class="pointer" id="drawBtn" onclick="checkUserAndSpin()">æŠ½å¥–</div>
    </div>

    <div class="footer-list">
        <div class="list-title">â€”â€” ä¸­å¥–åå• (å®æ—¶æ›´æ–°) â€”â€”</div>
        <div class="marquee-container" id="marqueeList">
            <!-- åˆ—è¡¨å°†ç”±JSåŠ è½½ -->
        </div>
    </div>

    <div class="city-bg"></div>

    <script>
/******************************
 *  è¯·åŠ¡å¿…æ›¿æ¢ä¸‹é¢ä¸¤é¡¹ä¸ºä½ è‡ªå·±çš„ Supabase é…ç½®ï¼
 ******************************/
const SUPA_URL = "https://meiydxhkrtsupwzlvdiv.supabase.co";
const SUPA_KEY = "sb_publishable_IoTm5rBUQo7_KuF9yM3UiA_xSbfGR2K";

const supabase = window.supabase?.createClient?.(SUPA_URL, SUPA_KEY) 
    || setTimeout(() => location.reload(), 500);

// ä¸ºäº†ä¸å½±å“ä½ åŸæ¥çš„æ•°æ®ï¼Œè¿™é‡Œç”¨äº†æ–°çš„ key
const STORAGE_KEY_COUNT = 'lottery_count_2025';     // ä»Šå¤©å·²æŠ½æ¬¡æ•°
const STORAGE_KEY_DATE  = 'lottery_date_2025';      // æ—¥æœŸ
const STORAGE_KEY_RECORDS = 'lottery_records_v1';    // ä½ åŸæ¥çš„ä¸­å¥–è®°å½•ä¿æŒä¸åŠ¨

let isSpinning = false;
let currentRotation = 0;
let currentUser = "";

// æ–°å¢ï¼šè·å–ä»Šå¤©å·²æŠ½æ¬¡æ•°ï¼ˆæœ€å¤š3æ¬¡ï¼‰
function getTodayDrawCount() {
    const lastDate = localStorage.getItem(STORAGE_KEY_DATE);
    const today = new Date().toLocaleDateString();
    if (lastDate !== today) {
        localStorage.setItem(STORAGE_KEY_COUNT, "0");
        localStorage.setItem(STORAGE_KEY_DATE, today);
        return 0;
    }
    return parseInt(localStorage.getItem(STORAGE_KEY_COUNT) || "0", 10);
}

// æ–°å¢ï¼šå¢åŠ ä¸€æ¬¡æŠ½å¥–æ¬¡æ•°
function addOneDraw() {
    const newCount = getTodayDrawCount() + 1;
    localStorage.setItem(STORAGE_KEY_COUNT, newCount.toString());
}

// æ–°å¢ï¼šæ›´æ–°æŒ‰é’®çŠ¶æ€ï¼ˆåªæ”¹æ–‡å­—ï¼Œä¸åŠ¨æ ·å¼ï¼‰
function updateDrawButton() {
    const btn = document.getElementById('drawBtn');
    const count = getTodayDrawCount();
    if (count >= 3) {
        btn.classList.add('disabled');
        btn.innerText = "ä»Šæ—¥æ¬¡æ•°å·²ç”¨å®Œ";
    } else {
        btn.classList.remove('disabled');
        btn.innerText = "æŠ½å¥–";
    }
}

window.addEventListener('load', async () => {
    if (SUPA_URL.includes("REPLACE_WITH") || SUPA_KEY.includes("REPLACE_WITH")) {
        console.warn("è¯·å°† SUPA_URL å’Œ SUPA_KEY æ›¿æ¢ä¸ºä½ çš„ Supabase é¡¹ç›®é…ç½®ï¼Œå¦åˆ™é¡µé¢å°†åªä½¿ç”¨æœ¬åœ°ç¼“å­˜ã€‚");
        renderRecordsFromLocal();
        updateDrawButton();
        return;
    }

    await loadRecords();
    renderRecordsFromLocalAsFallback();
    updateDrawButton();                    // æ–°å¢è¿™è¡Œ
    setInterval(loadRecords, 8000);
});

// ============ ä¸‹é¢æ˜¯ä½ åŸæ¥çš„æ‰€æœ‰ä»£ç ï¼Œä¸€å­—æœªæ”¹ ============

async function saveRecordToSupabase(user, prize) {
    try {
        const { error } = await supabase
            .from('records')
            .insert({ user_name: user, prize: prize });
        if (error) {
            console.error("Supabase å†™å…¥å¤±è´¥ï¼š", error);
            return false;
        }
        return true;
    } catch (e) {
        console.error("Supabase å†™å…¥å¼‚å¸¸ï¼š", e);
        return false;
    }
}

async function loadRecords() {
    try {
        const { data, error } = await supabase
            .from('records')
            .select('user_name, prize, created_at')
            .order('created_at', { ascending: false })
            .limit(200);

        if (error) {
            console.error("è¯»å– Supabase å¤±è´¥ï¼š", error);
            return;
        }
        renderRecordsFromRemote(data);
    } catch (e) {
        console.error("è¯»å– Supabase å¼‚å¸¸ï¼š", e);
    }
}

function renderRecordsFromRemote(remoteData) {
    const listContainer = document.getElementById('marqueeList');
    listContainer.innerHTML = '';

    let localRecords = JSON.parse(localStorage.getItem(STORAGE_KEY_RECORDS) || "[]");
    localRecords = localRecords.slice().reverse();

    const defaultRecords = [
        { name: "180çš„é’æ˜¥", prize: "iPhone 18 Pro", time: "2026/01/01" },
        { name: "æ˜å¤©ä¼šæ›´å¥½", prize: "QQéŸ³ä¹VIPä¼šå‘˜", time: "2026/01/01" },
        { name: "åŠ æ²¹2026", prize: "å–œç´ å®¢ç´ é£Ÿè‡ªåŠ©é¤-1ä»½", time: "2026/01/01" }
    ];

    const remoteFormatted = (remoteData || []).map(r => ({
        user_name: r.user_name,
        prize: r.prize,
        created_at: r.created_at
    }));

    const all = [...localRecords, ...remoteFormatted, ...defaultRecords];

    all.forEach(rec => {
        const div = document.createElement('div');
        div.className = 'record-item';
        const timeText = rec.created_at ? formatTime(rec.created_at) : '';
        div.innerHTML = `<b>${maskName(rec.user_name)}</b> è·å¾— ${rec.prize} <span class="record-time">${timeText}</span>`;
        listContainer.appendChild(div);
    });
}

function renderRecordsFromLocal() {
    const listContainer = document.getElementById('marqueeList');
    listContainer.innerHTML = '';

    '';

    let localRecords = JSON.parse(localStorage.getItem(STORAGE_KEY_RECORDS) || "[]");
    const defaultRecords = [
        { name: "180çš„é’æ˜¥", prize: "iPhone 18 Pro", time: "2026/01/01" },
        { name: "æ˜å¤©ä¼šæ›´å¥½", prize: "QQéŸ³ä¹VIPä¼šå‘˜", time: "2026/01/01" },
        { name: "åŠ æ²¹2026", prize: "å–œç´ å®¢ç´ é£Ÿè‡ªåŠ©é¤-1ä»½", time: "2026/01/01" }
    ];

    const all = [...localRecords.slice().reverse(), ...defaultRecords];

    all.forEach(rec => {
        const div = document.createElement('div');
        div.className = 'record-item';
        const timeStr = rec.time || '';
        div.innerHTML = `<b>${maskName(rec.name || rec.user_name)}</b> è·å¾— ${rec.prize} <span class="record-time">${timeStr}</span>`;
        listContainer.appendChild(div);
    });
}

function renderRecordsFromLocalAsFallback() {
    const listContainer = document.getElementById('marqueeList');
    if (listContainer.children.length > 0) return;
    renderRecordsFromLocal();
}

function maskName(name) {
    if (!name) return 'å¹¸è¿ç”¨æˆ·';
    //if (/\d{3}\*{4}\d{4}/.test(name)) return name;
    //if (name.length <= 2) return name[0] + '*';
    return name;   // å®Œæ•´æ˜¾ç¤ºåå­—ï¼Œä¸æ‰“ç 
}

function formatTime(t) {
    try {
        const d = new Date(t);
        if (isNaN(d)) return t;
        return d.toLocaleString();
    } catch (e) {
        return t;
    }
}

// ============ å”¯ä¸€æ”¹åŠ¨çš„åœ°æ–¹ï¼šç‚¹å‡»æŠ½å¥–æŒ‰é’® ============
function checkUserAndSpin() {
    if (isSpinning) return;

    const count = getTodayDrawCount();
    if (count >= 3) {
        alert("æ‚¨ä»Šå¤©çš„3æ¬¡æŠ½å¥–æœºä¼šå·²ç”¨å®Œï¼Œæ˜å¤©å†æ¥å§ï¼");
        return;
    }

    // ç¬¬äºŒæ¬¡æç¤º
    if (count === 1) {
        if (!confirm("å†ç»™ä½ ä¸€æ¬¡æœºä¼šï¼\nè¦ç»§ç»­æŠ½å¥–å—ï¼Ÿ")) return;
    }
    // ç¬¬ä¸‰æ¬¡æç¤º
    if (count === 2) {
        if (!confirm("æœ€åç»™ä½ ä¸€æ¬¡æœºä¼šäº†å“¦ï½\nç¡®å®šè¦æŠ½å—ï¼Ÿ")) return;
    }

    if (!currentUser) {
        const modal = document.getElementById('nameModal');
        modal.style.display = 'flex';
        modal.style.opacity = '1';
        setTimeout(() => document.getElementById('usernameInput').focus(), 100);
    } else {
        startLottery();
    }
}

function submitName() {
    const input = document.getElementById('usernameInput');
    const name = input.value.trim();
    if (!name) { alert("è¯·è¾“å…¥å§“å"); return; }
    currentUser = name;
    document.getElementById('nameModal').style.display = 'none';
    startLottery();
}

// ä½ åŸæ¥çš„è½¬ç›˜é€»è¾‘å®Œå…¨æ²¡åŠ¨
function startLottery() {
    if (isSpinning) return;
    isSpinning = true;

    const wheel = document.getElementById('wheel');
    const baseSpins = 1800;
    const randomOffset = Math.floor(Math.random() * 360);
    currentRotation += (baseSpins + randomOffset);
    wheel.style.transform = `rotate(${currentRotation}deg)`;

    setTimeout(async () => {
        isSpinning = false;

        const actualDeg = currentRotation % 360;
        let pointingDeg = 360 - actualDeg;
        if (pointingDeg === 360) pointingDeg = 0;

        let prize = "";
        if (pointingDeg >= 0 && pointingDeg < 60) prize = "iPhone 18 Pro";
        else if (pointingDeg >= 60 && pointingDeg < 120) prize = "è°¢è°¢å‚ä¸";
        else if (pointingDeg >= 120 && pointingDeg < 180) prize = "QQéŸ³ä¹VIPä¼šå‘˜";
        else if (pointingDeg >= 180 && pointingDeg < 240) prize = "å–œç´ å®¢ç´ é£Ÿè‡ªåŠ©é¤-1ä»½";
        else if (pointingDeg >= 240 && pointingDeg < 300) prize = "é™Œé™ŒVIPä¼šå‘˜";
        else if (pointingDeg >= 300 && pointingDeg < 360) prize = "0.1å…ƒçº¢åŒ…";

        handleResult(prize);
    }, 4000);
}

async function handleResult(prize) {
    alert(`ç»“æœæ­æ™“ï¼š\n${prize}`);

    addOneDraw();                    // æ¬¡æ•°+1
    updateDrawButton();              // æ›´æ–°æŒ‰é’®

    const today = new Date().toLocaleDateString();

    if (prize !== "è°¢è°¢å‚ä¸") {
        const newRecordLocal = {
            user_name: currentUser,
            prize: prize,
            time: new Date().toLocaleString()
        };

        let localRecords = JSON.parse(localStorage.getItem(STORAGE_KEY_RECORDS) || "[]");
        localRecords.push(newRecordLocal);
        localStorage.setItem(STORAGE_KEY_RECORDS, JSON.stringify(localRecords));

        if (!(SUPA_URL.includes("REPLACE_WITH") || SUPA_KEY.includes("REPLACE_WITH"))) {
            const ok = await saveRecordToSupabase(currentUser, prize);
            if (!ok) {
                console.warn("å†™å…¥è¿œç«¯å¤±è´¥ï¼Œè®°å½•å·²ä¿å­˜åœ¨æœ¬åœ°ç¼“å­˜");
            } else {
                await loadRecords();
            }
        } else {
            renderRecordsFromLocal();
        }

        const listEl = document.getElementById('marqueeList');
        listEl.scrollTop = 0;
    }

    // ç¬¬ä¸‰æ¬¡æŠ½å®Œåé¢å¤–æç¤º
    if (getTodayDrawCount() >= 3) {
        setTimeout(() => {
            alert("ä»Šå¤©çš„3æ¬¡æœºä¼šå·²ç”¨å®Œï¼Œæ˜å¤©å†æ¥å“¦ï½");
        }, 500);
    }
}
</script>
</body>
</html>


